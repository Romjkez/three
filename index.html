<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>3D // Meshkov Roman // 171-331</title>
    <style>
        body {
            margin: 0;
        }

        canvas {
            display: block;
        }
    </style>
</head>
<body>
<script type="module">
    import * as THREE from './js/three.module.js';
    import {OrbitControls} from "./js/orbitControls.js";
    import {StereoEffect} from "./js/StereoEffect.js";

    let isReducing = false;
    let listener, sound, audioLoader, effect;
    const musicBtn = document.getElementById('musicBtn');
    const stereoBtn = document.getElementById('stereoBtn');

    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, .1, 1000);
    const renderer = new THREE.WebGLRenderer({alpha: true});
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(window.devicePixelRatio);
    document.body.appendChild(renderer.domElement);


    const boxGeometry = new THREE.BoxGeometry();
    const cylinderGeometry = new THREE.CylinderGeometry();
    const ringGeometry = new THREE.RingGeometry();
    const cube = new THREE.Mesh(boxGeometry, new THREE.MeshBasicMaterial({color: '#0015f1'}));
    const cylinder = new THREE.Mesh(cylinderGeometry, new THREE.MeshBasicMaterial());
    const ring = new THREE.Mesh(ringGeometry, new THREE.MeshBasicMaterial({color: '#ee2222'}));
    cylinder.position.x = -5
    cylinder.position.y = 1.2
    ring.position.x = 5;
    ring.position.y = 1.2;
    scene.add(cube);
    scene.add(cylinder);
    scene.add(ring);
    camera.position.z = 10;
    camera.position.y = 10;

    // Orbit controls
    let controls = new OrbitControls(camera, renderer.domElement);
    controls.addEventListener('change', render);
    controls.minDistance = 10;
    controls.maxDistance = 15000;
    controls.enablePan = false;

    // Light
    let spotLight = new THREE.SpotLight(0xffffff, 1, 200, Math.PI / 4, .5, 2);
    spotLight.position.set(15, 40, 35);

    spotLight.castShadow = true;
    spotLight.shadow.mapSize.width = 1024;
    spotLight.shadow.mapSize.height = 1024;
    spotLight.shadow.camera.near = 10;
    spotLight.shadow.camera.far = 200;
    scene.add(spotLight);

    // Ground
    let groundMaterial = new THREE.MeshPhongMaterial({color: '#255205', dithering: true});
    let groundGeometry = new THREE.PlaneBufferGeometry(100, 100);
    let mesh = new THREE.Mesh(groundGeometry, groundMaterial);
    mesh.position.set(0, 0, 0);
    mesh.rotation.x = -Math.PI * 0.5;
    mesh.receiveShadow = true;
    scene.add(mesh);

    // Skybox
    const cubeTextureLoader = new THREE.CubeTextureLoader();
    const skyboxTexture = cubeTextureLoader.load((new Date().getHours() > 6 && new Date().getHours() < 21) ? [
        'img/bluecloud_ft.jpg',
        'img/bluecloud_bk.jpg',
        'img/bluecloud_up.jpg',
        'img/bluecloud_dn.jpg',
        'img/bluecloud_rt.jpg',
        'img/bluecloud_lf.jpg',
    ] : [
        'img/space_ft.png',
        'img/space_bk.png',
        'img/space_up.png',
        'img/space_dn.png',
        'img/space_rt.png',
        'img/space_lf.png',
    ]);
    scene.background = skyboxTexture;

    function animate() {
        requestAnimationFrame(animate);
        render();
    }

    function render() {
        // Matrix transformation of cube
        if (Date.now() % 5 === 0) {
            if (cube.matrix.elements[0] < 10) {
                cube.matrix.copy(new THREE.Matrix4().set(
                    (cube.matrix.elements[0] + 1), 0, 0, 0,
                    0, 1, 0, 3,
                    0, 0, 1, 3,
                    0, 0, 0, 1))
            } else {
                cube.matrix.copy(new THREE.Matrix4().set(
                    1, 0, 0, 0,
                    0, 1, 0, 3,
                    0, 0, 1, 3,
                    0, 0, 0, 1))
            }
        }
        cube.matrixAutoUpdate = false

        cube.rotation.y += 0.01;

        ring.rotation.z += 0.02;

        if (ring.scale.y > 2 && isReducing === false) {
            isReducing = true;
        } else if (ring.scale.y < .5 && isReducing === true) {
            isReducing = false;
        }

        if (isReducing) {
            ring.scale.y -= 0.01;
            ring.scale.x -= 0.01;
        } else {
            ring.scale.y += 0.02;
            ring.scale.x += 0.02;
        }

        cylinder.rotation.x += 0.02;
        cylinder.rotation.z += 0.01;
        cylinder.rotation.y -= 0.01;
        renderer.render(scene, camera);
        if (effect) effect.render(scene, camera);
    }

    function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;

        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
        if (effect) effect.setSize(window.innerWidth, window.innerHeight);
    }

    function switchAudio() {
        if (!listener && !sound) {
            listener = new THREE.AudioListener();
            camera.add(listener);

            sound = new THREE.Audio(listener);

            audioLoader = new THREE.AudioLoader();
            audioLoader.load('sounds/de_inferno.mp3', buffer => {
                sound.setBuffer(buffer);
                sound.setLoop(true);
                sound.setVolume(0.4);
                sound.play();
            });
            musicBtn.innerText = 'Stop music';
        } else if (sound.isPlaying) {
            sound.pause();
            musicBtn.innerText = 'Resume music';
        } else {
            sound.play();
            musicBtn.innerText = 'Stop music';
        }
    }

    function toggleStereo() {
        if (effect) {
            effect = null
            window.dispatchEvent(new Event('resize'));
        } else {
            effect = new StereoEffect(renderer);
            effect.setSize(window.innerWidth, window.innerHeight);
        }
    }

    window.addEventListener('resize', onWindowResize, false);
    musicBtn.addEventListener('click', switchAudio);
    stereoBtn.addEventListener('click', toggleStereo)

    toggleStereo();
    animate();
</script>
<div style="display: flex; position: absolute; top: 1px; left: 1px">
    <button id="musicBtn" type="button">Play music</button>
    <button id="stereoBtn" type="button">Toggle stereo camera</button>
</div>
</body>
</html>
